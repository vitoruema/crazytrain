<html>
  <head>
	<title>Crazy train!</title>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
    
    // Load the Visualization API and the piechart package.
    google.load('visualization', '1.0', {'packages':['corechart']});
      
    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback();
	
	/*
	 * Set configurations and draw the chart
	 */
	function drawChart() {
        var chart = new google.visualization.LineChart(
                document.getElementById('chart_div'));
		
	    var options = {width: 800,
                       height: 600,
					   interpolateNulls: true,
					   pointSize: 2,
					   vAxis: {format: '##'}
					   };
					   
		chart.draw(createDataTable(getTrains(getInput())), options);
    }
	
	/*
	 * Return the input text from the textarea.
	 */
	function getInput() {
		return document.getElementById('input').value;
	}

	/*
	 * Create a table containing the data that will be used to plot the chart.
	 */
	function createDataTable(trains) {
		var data = new google.visualization.DataTable();
		// A primeira coluna é referente ao horário dos pontos da rota
		// do trem
		data.addColumn('datetime', 'Horario'); // Implicit domain column
		// As colunas seguintes são referentes a cada trem
		for (var i = 0; i < trains.length; i++) {
			// Assume que os trens nas linhas vão estar na mesma ordem
			data.addColumn('number', trains[i].name); // Implicit data column.
		}
		// Adiciona as linhas contendo os horários e as vias dos trens para
		// estes horários, caso existam
		var rows = trainPointsToRows(trains);
		for (var i = 0; i < rows.length; i++) {
			rows[i];
			data.addRow(rows[i]);
		}
		return data;
	}
	
	/*
	 * Verifica se o sentido do trem é invertido.
	 */
	function trainPointsToRows(trains) {
		var dates = new Array();
		var segments = new Array();
		var trainsInfo = {};
		// Para cada trem
		for (var i = 0; i < trains.length; i++) {
			var trainRoute = trains[i].route;
			var trainName = trains[i].name;
			// Inicia a tabela de informações do trem
			trainsInfo[trainName] = {};
			// Para cada ponto na rota do trem
			for (var j = 0; j < trainRoute.length; j++) {
				var date = trainRoute[j].date;
				var track = trainRoute[j].track;
				// Adiciona o horário do ponto à lista de datas se ele
				// não estiver contido na lista
				if (dates.indexOf(date) == -1) {
					dates.push(date);
				}
				var segment = segmentFromTrack(track);
				// Adiciona o segmento referente à via deste ponto à lista
				// de segmentos caso ele não esteja contido na lista
				if (segments.indexOf(segment) == -1) {
					segments.push(segment);
				}
				// Associa a ocupação da via a um horário específico para
				// cada trem
				trainsInfo[trainName][date] = track;
			}
		}
		// Ordena os segmentos e as datas. Note que o algoritmo presume que
		// os segmentos estão nomeados e ordenados em ordem alfabética. Assim,
		// a representação das rotas não será fiel caso este não seja o caso.
		segments.sort();
		dates.sort();
		var rows = new Array();
		// Para cada data
		for (var i = 0; i < dates.length; i++) {
			var date = dates[i];
			// Cria uma linha na tabela de dados
			rows[i] = new Array();
			// Com a primeira coluna correspondente à data
			rows[i].push(new Date(date));
			// E as colunas restantes correspondentes a cada trem
			for (var j = 0; j < trains.length; j++) {
				var train = trains[j];
				var track = trainsInfo[train.name][date];
				// Onde a coluna contém a informação da via, se o trem
				// tiver um ponto composto por esta data e esta via
				if (track) {
					var segmentNumber = segments.indexOf(segmentFromTrack(track));
					if (isReversed(train, segments)) {
						segmentNumber += 1;
					}
					rows[i].push({v: segmentNumber, f: track});
				}
				// Ou null, caso o ponto não exista
				else {
					rows[i].push(null);
				}
			}
		}
		return rows;
	}
	
	/*
	 * Retorna o segmento referente à via passada como argumento.
	 */
	function segmentFromTrack(track) {
		return track.split("_")[0];
	}
	
	/*
	 * Extrai os nomes e as rotas dos trens do texto de entrada e armazena
	 * estas informações numa lista de trens.
	 */
	function getTrains(input) {
		var trains = new Array();
		// Cria os padrões para detectar trens e pontos
		var trainPattern = /T[0-9]+/i;
		var pointPattern = /[A-Z]_[0-9]+ ; .*/i
		// Quebra o input em linhas.
		var lines = input.split("\n");
		// Para cada linha,
		for (var i = 0; i < lines.length; i++) {
			var trainMatch = trainPattern.exec(lines[i]);
			var pointMatch = pointPattern.exec(lines[i]);
			// Se a linha contém o nome de um trem
			if (trainMatch) {
				// Extrai o nome do trem
				trainName = trainMatch[0];
				// Adiciona o trem a lista de trens
				train = {name: trainName, route: new Array()}
				trains.push(train);
			}
			// Se a linha contem informação de um ponto
			else if (pointMatch) {
				var pointSplit = pointMatch[0].split(" ; ")
				var track = pointSplit[0];
				var date = pointSplit[1];
				// Cria um par com identificação da via e da hora e adiciona às
				// informações do trem
				train.route.push({date: date, track: track})
			}
		}
		return trains;
	}
	
	/*
	 * Verifica se o sentido do trem é invertido.
	 */
	function isReversed(train, segments) {
		// O sentido do trem é invertido se o índice do primeiro segmento do
		// percurso do trem é maior que o índice do último segmento
		return (segments.indexOf(segmentFromTrack(train.route[0].track)) >
				segments.indexOf(segmentFromTrack(train.route[train.route.length - 1].track)))
	}
    </script>
  </head>

  <body>
	<div style="width: 100%; display: table;">
		<div style="display: table-row">
			<h1>Crazy train</h1>
		</div>
		<div style="display: table-row">
			<div style="width:400; height:300; display: table-cell">
				<form>
					<textarea id="input" rows="35" cols="60"></textarea>
					<input type="button" value="Plotar" onClick="drawChart();">
				</form>
			</div>
			<div id="chart_div"
				 style="width:800; height:600; display: table-cell">
			</div>
		</div>
	</div>
  </body>
</html>